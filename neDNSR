#!/bin/bash

# --- 1. Entorno y Rutas ---
BASE_DIR="/opt/neDNSR"
LIB_DIR="$BASE_DIR/lib"
MASTER_LIST="$BASE_DIR/master_resolvers.txt"

# --- 2. Carga Dinámica de Módulos ---
# Esto importa automáticamente collector.sh, processor.sh, etc.
if [ -d "$LIB_DIR" ]; then
    for module in "$LIB_DIR"/*.sh; do
        source "$module"
    done
else
    echo "[-] Error: No se encontró la carpeta de librerías: $LIB_DIR"; exit 1
fi

# --- 3. Gestión de Argumentos ---
THREADS=100
DOMAIN=""
while getopts "d:t:h" opt; do
    case $opt in
        d) DOMAIN=$OPTARG ;;
        t) THREADS=$OPTARG ;;
        *) echo "Uso: neDNSR -d <dominio> [-t <pps>]"; exit 1 ;;
    esac
done

[[ -z "$DOMAIN" ]] && { echo "[!] Falta dominio (-d)"; exit 1; }

# --- 4. PIPELINE DE EJECUCIÓN ---
echo "--- Iniciando Pipeline de neDNSR para: $DOMAIN ---"

# Paso 1: Recolectar y limpiar la lista maestra (collector.sh)
run_collector "$THREADS"

# Paso 2: Generar salida específica para el dominio (processor.sh)
# Esta función debería leer el Master y sacar el archivo final para el usuario
if [ -f "$MASTER_LIST" ]; then
    finalize_target_list "$MASTER_LIST" "$DOMAIN" "trusted_resolvers.txt"
fi

echo "--- Pipeline Finalizado ---"