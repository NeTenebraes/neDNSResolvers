#!/bin/bash
# /opt/neDNSR/neDNSR

BASE_DIR="/opt/neDNSR"
LIB_DIR="$BASE_DIR/lib"
RAW_FILE="$BASE_DIR/RAW.txt"
LIVE_FILE="$BASE_DIR/LIVE.txt"

source "$LIB_DIR/helpers.sh"
source "$LIB_DIR/collector.sh"
source "$LIB_DIR/validator.sh"

trap cleanup SIGINT SIGTERM

# --- Valores por defecto ---
THREADS=200
LIMIT="all"
MODE="direct" # Por defecto, solo IP exacta
UPDATE_MODE=false
DEFAULT_OUTPUT="resolvers_$(date +%Y%m%d_%H%M).txt"
OUTPUT=""

usage() {
    echo -e "\e[1;37mneDNSR - Herramienta de Recolección de Resolvers para Bug Bounty\e[0m"
    echo -e "Uso: neDNSR -d <dominio> [-m <mode>] [-o <archivo>] [-t <hilos>] [-top <numero>] [--update]"
    echo -e "  -d      : Dominio para el benchmark (ej: google.com)"
    echo -e "  -m      : Modo de comparación: \e[32mdirect\e[0m (IP exacta) o \e[35mfull\e[0m (Rango Red + DNSValidator)"
    echo -e "  -o      : Archivo de salida (default: $DEFAULT_OUTPUT)"
    echo -e "  -t      : Número de hilos (default: 200)"
    echo -e "  -top    : Cantidad de mejores DNS a filtrar (default: all)"
    echo -e "  --update: Ingesta nuevas fuentes y re-valida integridad con DNSValidator (RAW -> LIVE)"
    exit 1
}

# --- Procesar argumentos ---
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d) DOMAIN="$2"; shift ;;
        -m) MODE="$2"; shift ;;
        -o) OUTPUT="$2"; shift ;;
        -t|-threads) THREADS="$2"; shift ;;
        -top) LIMIT="$2"; shift ;;
        --update) UPDATE_MODE=true ;;
        -h|--help) usage ;;
        *) echo "Opción desconocida: $1"; usage ;;
    esac
    shift
done

[[ -z "$DOMAIN" ]] && usage
[[ -z "$OUTPUT" ]] && OUTPUT="$DEFAULT_OUTPUT"

# --- FLUJO DE TRABAJO ---
# 1. Ingesta y Validación (Solo si no hay LIVE o se pide --update)
if [[ ! -f "$LIVE_FILE" ]] || [[ "$UPDATE_MODE" == true ]]; then
    echo -e "\e[1;33m[*] Iniciando actualización de base maestra...\e[0m"
    update_master_raw
    validate_raw_to_live "$THREADS"
fi

# 2. Limpieza antes del benchmark
clean_live_logic

# 3. Benchmark y ranking
measure_and_rank "$LIVE_FILE" "$OUTPUT" "$LIMIT" "$THREADS" "$DOMAIN" "$MODE"