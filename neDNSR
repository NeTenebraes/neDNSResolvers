#!/bin/bash

# --- Configuración de Entorno ---
BASE_DIR=$(dirname "$(readlink -f "$0")")
LIB_DIR="$BASE_DIR/lib"
MASTER_LIST="$BASE_DIR/master_resolvers.txt"
TEMP_DIR=$(mktemp -d /tmp/neDNSR.XXXXXX)
trap 'rm -rf "$TEMP_DIR"' EXIT

# --- Carga Dinámica de Librerías ---
if [ -d "$LIB_DIR" ]; then
    while IFS= read -r -d '' file; do source "$file"; done < <(find "$LIB_DIR" -type f -name "*.sh" -print0)
else
    echo "[-] Error: Librerías no encontradas en $LIB_DIR"; exit 1
fi

# --- Argumentos ---
THREADS=100; DOMAIN=""; OUTPUT="trusted_resolvers.txt"; TOP_N=0
while getopts "d:t:o:n:h" opt; do
    case $opt in
        d) DOMAIN=$OPTARG ;;
        t) THREADS=$OPTARG ;;
        o) OUTPUT=$OPTARG ;;
        n) TOP_N=$OPTARG ;;
        *) echo "Uso: neDNSR -d <dominio> [-t <hilos>] [-o <salida>] [-n <top_n>]"; exit 1 ;;
    esac
done
[[ -z "$DOMAIN" ]] && exit 1

# --- FLUJO PRINCIPAL ---

# --- PARTE 1: RECOLECCIÓN DE NOVEDADES ---
echo "[+] Iniciando recolección para $DOMAIN..."
fetch_RAW "$MASTER_LIST" "$TEMP_DIR/only_new.txt"

# --- PARTE 2: VALIDACIÓN E INSERCIÓN (ESTO TE FALTABA) ---
if [ -s "$TEMP_DIR/only_new.txt" ]; then
    echo "[*] Capa 1: Filtrado masivo (MassDNS)..."
    process_and_update_master "$TEMP_DIR/only_new.txt" "$MASTER_LIST" "$THREADS" "$TEMP_DIR"
else
    echo "[*] No hay candidatos nuevos que procesar."
fi

# --- PARTE 3: GENERACIÓN DE RESULTADOS ---
# Eliminamos el 'exit 1' agresivo para que si el Master está vacío, 
# intente al menos informar por qué.
if [ -s "$MASTER_LIST" ]; then
    FINAL_COUNT=$(finalize_target_list "$MASTER_LIST" "$DOMAIN" "$OUTPUT" "$TOP_N")
    
    echo "-------------------------------------------------------"
    if [ "$FINAL_COUNT" -gt 0 ]; then
        echo -e "[DONE] Master: $(wc -l < "$MASTER_LIST") | Salida: $FINAL_COUNT ($OUTPUT)"
    else
        echo -e "[!] Advertencia: No se obtuvieron resolvers válidos para $DOMAIN"
        rm -f "$OUTPUT"
    fi
    echo "-------------------------------------------------------"
else
    echo "[-] Error: El Master List sigue vacío después del procesamiento."
    exit 1
fi