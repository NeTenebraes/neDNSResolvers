#!/bin/bash
# /opt/neDNSR/neDNSR

BASE_DIR="/opt/neDNSR"
MASTER_LIST="$BASE_DIR/master_resolvers.txt"
LIB_DIR="$BASE_DIR/lib"
DNS_VENV="$LIB_DIR/dns_env/bin/dnsvalidator" 

source "$LIB_DIR/collector.sh"
source "$LIB_DIR/validator.sh"

trap cleanup SIGINT SIGTERM

# Valores por defecto
THREADS=100
LIMIT=1000
DOMAIN="google.com"
OUTPUT="fast_resolvers.txt"

usage() {
    echo "Uso: neDNSR -d <dominio> [-t <hilos>] [-l <limite>] [-o <archivo>]"
    echo "  -d: Dominio para el benchmark (Ej: target.com)"
    echo "  -l: Top N DNS rápidos a filtrar (Ej: 100 o 1000)"
    echo "  -t: Hilos para validación y benchmark"
    exit 1
}

while getopts "d:t:l:o:" opt; do
    case $opt in
        d) DOMAIN=$OPTARG ;;
        t) THREADS=$OPTARG ;;
        l) LIMIT=$OPTARG ;;
        o) OUTPUT=$OPTARG ;;
        *) usage ;;
    esac
done

[[ -z "$DOMAIN" ]] && usage

# PASO 1: Recolectar de fuentes públicas
fetch_and_merge 

# PASO 2: Validación de Integridad (DNSValidator)
# Filtra resolvers que están caídos o dan respuestas falsas (spoofing)
echo "[*] Ejecutando DNSValidator sobre la lista maestra..." >&2
TMP_VALIDATED=$(mktemp)
$DNS_VENV -tL "$MASTER_LIST" -threads "$THREADS" -o "$TMP_VALIDATED"

# PASO 3: Ranking por Latencia y Filtro Final
# Solo los que pasaron DNSValidator entran al benchmark de velocidad
COUNT=$(measure_and_rank "$TMP_VALIDATED" "$OUTPUT" "$LIMIT" "$THREADS" "$DOMAIN")

echo -e "\n[+] Proceso finalizado exitosamente."
echo "[+] DNS Validados y Rápidos: $COUNT"
echo "[+] Resultados guardados en: $OUTPUT"

rm -f "$TMP_VALIDATED"