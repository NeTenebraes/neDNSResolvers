#!/bin/bash
# /opt/neDNSR/neDNSR

BASE_DIR="/opt/neDNSR"
LIB_DIR="$BASE_DIR/lib"
RAW_FILE="$BASE_DIR/RAW.txt"
LIVE_FILE="$BASE_DIR/LIVE.txt"

source "$LIB_DIR/helpers.sh"
source "$LIB_DIR/collector.sh"
source "$LIB_DIR/validator.sh"

trap cleanup SIGINT SIGTERM

# Valores por defecto
THREADS=300
LIMIT="all"
UPDATE_MODE=false
DEFAULT_OUTPUT="resolvers_$(date +%Y%m%d_%H%M).txt"
OUTPUT=""

usage() {
    echo -e "Uso: neDNSR -d <dominio> [-o <archivo>] [-t <hilos>] [-top <numero>] [--update]"
    echo -e "  -d    : Dominio para el benchmark (ej: google.com)"
    echo -e "  -o    : Archivo de salida (default: resolvers_FECHA_HORA.txt)"
    echo -e "  -t    : Número de hilos/concurrencia (default: 300)"
    echo -e "  -top  : Cantidad de mejores DNS a filtrar (default: todos los vivos)"
    echo -e "  --update : Ingesta nuevas fuentes y re-valida integridad (RAW -> LIVE)"
    exit 1
}

# Procesar argumentos
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d) DOMAIN="$2"; shift ;;
        -o) OUTPUT="$2"; shift ;;
        -t|-threads) THREADS="$2"; shift ;;
        -top) LIMIT="$2"; shift ;;
        --update) UPDATE_MODE=true ;;
        *) usage ;;
    esac
    shift
done

[[ -z "$DOMAIN" ]] && usage
[[ -z "$OUTPUT" ]] && OUTPUT="$DEFAULT_OUTPUT"

# --- FLUJO DE TRABAJO ---

# Debug de rutas (Añade esto temporalmente)
echo "[DEBUG] Buscando LIVE en: $LIVE_FILE"
if [[ -f "$LIVE_FILE" ]]; then
    echo "[DEBUG] LIVE detectado. Tamaño: $(wc -l < "$LIVE_FILE")"
else
    echo "[DEBUG] LIVE NO detectado. Iniciando actualización forzosa."
fi

# Tu lógica actual corregida
if [[ ! -f "$LIVE_FILE" ]] || [[ "$UPDATE_MODE" == true ]]; then
    update_master_raw
    validate_raw_to_live "$THREADS"
fi

# 1. Ingesta y Validación (Solo si no hay LIVE o se pide --update)
if [[ ! -f "$LIVE_FILE" ]] || [[ "$UPDATE_MODE" == true ]]; then
    update_master_raw
    validate_raw_to_live "$THREADS"
fi

# 2. Saneamiento de supervivencia (Siempre se hace para limpiar LIVE antes del benchmark)
clean_live_logic

# 3. Benchmark y ranking (Escupiendo datos en tiempo real)
measure_and_rank "$LIVE_FILE" "$OUTPUT" "$LIMIT" "$THREADS" "$DOMAIN"