#!/bin/bash
# /opt/neDNSR/neDNSR

BASE_DIR="/opt/neDNSR"
LIB_DIR="$BASE_DIR/lib"
# Importar helpers primero para tener acceso a cleanup 
source "$LIB_DIR/helpers.sh"

# Registrar el trap usando la funci칩n que est치 dentro de helpers.sh [cite: 4]
trap cleanup SIGINT SIGTERM

# Resto de imports 
source "$LIB_DIR/collector.sh"
source "$LIB_DIR/validator.sh"

# Valores por defecto
THREADS=100
LIMIT=1000
DOMAIN="google.com"
OUTPUT="fast_resolvers.txt"

usage() {
    echo "Uso: neDNSR -d <dominio> [-t <hilos>] [-l <limite>] [-o <archivo>]"
    echo "  -d: Dominio para el benchmark (Ej: target.com)"
    echo "  -l: Top N DNS r치pidos a filtrar (Ej: 100 o 1000)"
    echo "  -t: Hilos para validaci칩n y benchmark"
    exit 1
}

while getopts "d:t:l:o:" opt; do
    case $opt in
        d) DOMAIN=$OPTARG ;;
        t) THREADS=$OPTARG ;;
        l) LIMIT=$OPTARG ;;
        o) OUTPUT=$OPTARG ;;
        *) usage ;;
    esac
done

[[ -z "$DOMAIN" ]] && usage

# PASO 1: Recolectar
fetch_and_merge

# PASO 2: Validar
echo "[*] Ejecutando DNSValidator..." >&2
TMP_VALIDATED=$(mktemp)
$DNS_VENV -tL "$MASTER_LIST" -threads "$THREADS" -o "$TMP_VALIDATED"

# PASO 3: Rankear (solo si hay resultados)
if [[ -s "$TMP_VALIDATED" ]]; then
    measure_and_rank "$TMP_VALIDATED" "$OUTPUT" "$LIMIT" "$THREADS" "$DOMAIN"
fi

rm -f "$TMP_VALIDATED"