#!/bin/bash

# --- Configuración de Entorno ---
BASE_DIR=$(dirname "$(readlink -f "$0")")
LIB_DIR="$BASE_DIR/lib"
MASTER_LIST="$BASE_DIR/master_resolvers.txt"
TEMP_DIR=$(mktemp -d /tmp/neDNSR.XXXXXX)
trap 'rm -rf "$TEMP_DIR"' EXIT

# --- Carga Dinámica de Librerías ---
if [ -d "$LIB_DIR" ]; then
    while IFS= read -r -d '' file; do source "$file"; done < <(find "$LIB_DIR" -type f -name "*.sh" -print0)
else
    echo "[-] Error: Librerías no encontradas en $LIB_DIR"; exit 1
fi

# --- Argumentos ---
THREADS=100; DOMAIN=""; OUTPUT="trusted_resolvers.txt"; TOP_N=0
while getopts "d:t:o:n:h" opt; do
    case $opt in
        d) DOMAIN=$OPTARG ;;
        t) THREADS=$OPTARG ;;
        o) OUTPUT=$OPTARG ;;
        n) TOP_N=$OPTARG ;;
        *) echo "Uso: neDNSR -d <dominio> [-t <hilos>] [-o <salida>] [-n <top_n>]"; exit 1 ;;
    esac
done
[[ -z "$DOMAIN" ]] && exit 1

# --- FLUJO PRINCIPAL ---

echo "[+] Iniciando recolección para $DOMAIN..."

# 1. Recolección de candidatos nuevos
fetch_public_resolvers "$TEMP_DIR/raw_candidates.txt"
if [ -f "$MASTER_LIST" ]; then
    comm -23 <(sort -u "$TEMP_DIR/raw_candidates.txt") <(sort -u "$MASTER_LIST") > "$TEMP_DIR/only_new.txt"
else
    cp "$TEMP_DIR/raw_candidates.txt" "$TEMP_DIR/only_new.txt"
fi

# 2. Procesamiento por capas (Solo si hay candidatos nuevos)
if [ -s "$TEMP_DIR/only_new.txt" ]; then
    filter_fast_responders "$TEMP_DIR/only_new.txt" "$TEMP_DIR/survivors.txt"
    
    if [ -s "$TEMP_DIR/survivors.txt" ]; then
        validate_integrity "$TEMP_DIR/survivors.txt" "$THREADS" "$TEMP_DIR/verified.txt"
        update_master "$TEMP_DIR/verified.txt" "$MASTER_LIST"
    fi
fi

# 3. Generación de resultados para el dominio específico
if [ -s "$MASTER_LIST" ]; then
    run_puredns_validation "$MASTER_LIST" "$DOMAIN" "$OUTPUT" "$TOP_N"
    FINAL_COUNT=$(grep -cE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" "$OUTPUT" 2>/dev/null || echo 0)
    echo "-------------------------------------------------------"
    echo "[DONE] Master: $(wc -l < "$MASTER_LIST") | Salida: $FINAL_COUNT"
else
    echo "[-] Error: No hay resolvers disponibles."
fi