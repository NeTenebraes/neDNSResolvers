#!/bin/bash
# /opt/neDNSR/neDNSR

BASE_DIR="/opt/neDNSR"
LIB_DIR="$BASE_DIR/lib"
RAW_FILE="$BASE_DIR/RAW.txt"
LIVE_FILE="$BASE_DIR/LIVE.txt"
DATE_FILE="$BASE_DIR/LIVE.date"

source "$LIB_DIR/helpers.sh"
source "$LIB_DIR/collector.sh"
source "$LIB_DIR/validator.sh"

trap cleanup SIGINT SIGTERM

# Valores por defecto
THREADS=300
LIMIT="all" # Por defecto infinito/todo
UPDATE_MODE=false

usage() {
    echo -e "Uso: neDNSR -d <dominio> [-o <archivo>] [-top <numero>] [--update]"
    echo -e "  -d    : Dominio para el benchmark (ej: google.com)"
    echo -e "  -o    : Archivo de salida (default: fast_resolvers.txt)"
    echo -e "  -top  : Número de mejores DNS a filtrar (default: todos)"
    echo -e "  --update : Ingesta nuevas fuentes y valida hacia LIVE"
    exit 1
}

# Procesar argumentos manualmente para soportar -top
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -d) DOMAIN="$2"; shift ;;
        -o) OUTPUT="$2"; shift ;;
        -top) LIMIT="$2"; shift ;;
        --update) UPDATE_MODE=true ;;
        -h|--help) usage ;;
        *) echo "Opción desconocida: $1"; usage ;;
    esac
    shift
done

[[ -z "$DOMAIN" ]] && usage
[[ -z "$OUTPUT" ]] && OUTPUT="fast_resolvers.txt"

# --- LÓGICA DE DOS CAPAS ---

if [[ ! -f "$LIVE_FILE" ]] || [[ "$UPDATE_MODE" == true ]]; then
    update_master_raw
    validate_raw_to_live "$THREADS"
fi

clean_live_logic

# Pasar el LIMIT (puede ser un número o "all")
measure_and_rank "$LIVE_FILE" "$OUTPUT" "$LIMIT" "$THREADS" "$DOMAIN"